<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Manager Testing Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .test-passed { background-color: #10b981; }
        .test-failed { background-color: #ef4444; }
        .test-running { background-color: #3b82f6; }
        .test-pending { background-color: #6b7280; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">File Manager Testing Suite</h1>
            <p class="text-gray-600">Test file upload, download, and scope-based storage features</p>

            <div class="mt-4 flex flex-wrap gap-2">
                <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">File Upload</span>
                <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">Download URLs</span>
                <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-medium">Scope Management</span>
                <span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm font-medium">TTL/Expiration</span>
            </div>
        </div>

        <!-- Configuration -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Configuration</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">API Base URL</label>
                    <input type="text" id="apiUrl" value="http://localhost:4103"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                    <input type="password" id="apiKey" placeholder="Enter your API key"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Company ID</label>
                    <input type="text" id="companyId" placeholder="Your company ID"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Agent ID (for agent scope)</label>
                    <input type="text" id="agentId" placeholder="Optional agent ID"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Session ID (for session scope)</label>
                    <input type="text" id="sessionId" placeholder="Optional session ID"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>

            <!-- File Upload Test Section -->
            <div class="mt-6 border-t pt-4">
                <h3 class="text-lg font-medium text-gray-900 mb-3">Test File Upload</h3>
                <div class="flex items-center gap-4">
                    <input type="file" id="testFile"
                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <select id="uploadScope" class="px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="temporary">Temporary (10 min)</option>
                        <option value="session">Session (24h)</option>
                        <option value="agent">Agent (7 days)</option>
                        <option value="team">Team (30 days)</option>
                        <option value="company">Company (Permanent)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Test Controls -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-900">Test Suite</h2>
                <div class="flex gap-2">
                    <button onclick="runAllTests()"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        Run All Tests
                    </button>
                    <button onclick="clearResults()"
                            class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium">
                        Clear Results
                    </button>
                </div>
            </div>

            <!-- Test Progress -->
            <div class="mb-4">
                <div class="flex justify-between text-sm text-gray-600 mb-1">
                    <span>Progress</span>
                    <span id="progressText">0 / 0</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <!-- Test Results Summary -->
            <div class="grid grid-cols-4 gap-2 mb-4">
                <div class="bg-gray-50 p-3 rounded-lg text-center">
                    <div class="text-2xl font-bold text-gray-700" id="totalTests">0</div>
                    <div class="text-xs text-gray-500">Total</div>
                </div>
                <div class="bg-green-50 p-3 rounded-lg text-center">
                    <div class="text-2xl font-bold text-green-600" id="passedTests">0</div>
                    <div class="text-xs text-gray-500">Passed</div>
                </div>
                <div class="bg-red-50 p-3 rounded-lg text-center">
                    <div class="text-2xl font-bold text-red-600" id="failedTests">0</div>
                    <div class="text-xs text-gray-500">Failed</div>
                </div>
                <div class="bg-blue-50 p-3 rounded-lg text-center">
                    <div class="text-2xl font-bold text-blue-600" id="pendingTests">0</div>
                    <div class="text-xs text-gray-500">Pending</div>
                </div>
            </div>
        </div>

        <!-- Individual Tests -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Test Cases</h2>
            <div id="testResults" class="space-y-3"></div>
        </div>

        <!-- Debug Console -->
        <div class="bg-gray-900 rounded-lg shadow-sm p-6 mt-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-white">Debug Console</h2>
                <button onclick="clearConsole()" class="text-gray-400 hover:text-white text-sm">Clear</button>
            </div>
            <div id="console" class="bg-black rounded p-4 h-64 overflow-y-auto font-mono text-sm text-green-400"></div>
        </div>
    </div>

    <script>
        // Test configuration
        const tests = [
            {
                name: "Upload Text File (Temporary Scope)",
                description: "Upload a text file with temporary scope (10 min TTL)",
                async run() {
                    const content = `Test file created at ${new Date().toISOString()}`;
                    const file = await uploadFile(content, 'test-temp.txt', 'temporary');

                    window.tempFileId = file.id;
                    log(`Uploaded temporary file: ${file.id}`);
                    log(`Download URL: ${file.downloadUrl}`);

                    return file.id && file.downloadUrl && file.scope.type === 'temporary';
                }
            },
            {
                name: "Upload File (Session Scope)",
                description: "Upload a file with session scope (24h TTL)",
                async run() {
                    const sessionId = document.getElementById('sessionId').value;
                    if (!sessionId) {
                        log('No session ID provided, using default session scope');
                    }

                    const content = 'Session scoped file content';
                    const file = await uploadFile(content, 'test-session.txt', 'session', sessionId);

                    window.sessionFileId = file.id;
                    log(`Uploaded session file: ${file.id}`);

                    return file.id && file.scope.type === 'session';
                }
            },
            {
                name: "Upload File (Agent Scope)",
                description: "Upload a file with agent scope (7 days TTL)",
                async run() {
                    const agentId = document.getElementById('agentId').value || 'test-agent';

                    const content = 'Agent scoped file content';
                    const file = await uploadFile(content, 'test-agent.txt', 'agent', agentId);

                    window.agentFileId = file.id;
                    log(`Uploaded agent file: ${file.id} for agent: ${agentId}`);

                    return file.id && file.scope.type === 'agent' && file.scope.ownerId === agentId;
                }
            },
            {
                name: "Verify Download URL Format",
                description: "Check that download URLs are properly formatted",
                async run() {
                    const content = 'URL test content';
                    const file = await uploadFile(content, 'url-test.txt', 'temporary');

                    log(`Download URL: ${file.downloadUrl}`);

                    // Check URL format
                    const isValidUrl = file.downloadUrl.includes('/api/files/') &&
                                      file.downloadUrl.includes('/download');

                    // Test download
                    const downloaded = await downloadFile(file.downloadUrl);
                    log(`Downloaded content matches: ${downloaded === content}`);

                    return isValidUrl && downloaded === content;
                }
            },
            {
                name: "List Files by Scope",
                description: "List files filtered by different scopes",
                async run() {
                    // Upload files to different scopes
                    await uploadFile('temp content', 'list-temp.txt', 'temporary');
                    await uploadFile('session content', 'list-session.txt', 'session');

                    // List temporary files
                    const tempFiles = await listFiles('temporary');
                    log(`Found ${tempFiles.length} temporary files`);

                    // List session files
                    const sessionFiles = await listFiles('session');
                    log(`Found ${sessionFiles.length} session files`);

                    return tempFiles.length > 0 && sessionFiles.length >= 0;
                }
            },
            {
                name: "Get File Info",
                description: "Retrieve file metadata and download URL",
                async run() {
                    if (!window.tempFileId) {
                        throw new Error("No test file ID available");
                    }

                    const info = await getFileInfo(window.tempFileId);
                    log(`File info: ${info.filename}, size: ${info.size}, scope: ${info.scope.type}`);

                    return info.id === window.tempFileId &&
                           info.filename &&
                           info.downloadUrl;
                }
            },
            {
                name: "Upload Base64 File",
                description: "Upload a file using base64 encoding",
                async run() {
                    const content = 'Base64 test content';
                    const base64 = btoa(content);

                    const file = await uploadBase64File(
                        base64,
                        'base64-test.txt',
                        'text/plain',
                        'temporary'
                    );

                    log(`Uploaded base64 file: ${file.id}`);

                    // Download and verify
                    const downloaded = await downloadFile(file.downloadUrl);
                    return downloaded === content;
                }
            },
            {
                name: "List Agent-Specific Files",
                description: "List files for a specific agent",
                async run() {
                    const agentId = document.getElementById('agentId').value || 'test-agent';

                    // Upload a file for this agent
                    await uploadFile('agent file', `agent-${Date.now()}.txt`, 'agent', agentId);

                    // List agent files
                    const agentFiles = await listAgentFiles(agentId);
                    log(`Found ${agentFiles.length} files for agent: ${agentId}`);

                    return agentFiles.length > 0 &&
                           agentFiles.every(f => f.scope.ownerId === agentId);
                }
            },
            {
                name: "List Session-Specific Files",
                description: "List files for a specific session",
                async run() {
                    const sessionId = document.getElementById('sessionId').value;
                    if (!sessionId) {
                        log('No session ID provided, skipping test');
                        return true;
                    }

                    // Upload a file for this session
                    await uploadFile('session file', `session-${Date.now()}.txt`, 'session', sessionId);

                    // List session files
                    const sessionFiles = await listSessionFiles(sessionId);
                    log(`Found ${sessionFiles.length} files for session: ${sessionId}`);

                    return sessionFiles.length > 0;
                }
            },
            {
                name: "Delete File",
                description: "Delete a file and verify it's removed",
                async run() {
                    // Create a file to delete
                    const file = await uploadFile('to be deleted', 'delete-me.txt', 'temporary');
                    log(`Created file to delete: ${file.id}`);

                    // Delete it
                    await deleteFile(file.id);
                    log(`Deleted file: ${file.id}`);

                    // Try to get info (should fail)
                    try {
                        await getFileInfo(file.id);
                        return false; // Should have thrown
                    } catch (error) {
                        log('Confirmed deletion - file not found');
                        return true;
                    }
                }
            },
            {
                name: "Test Pagination",
                description: "Test file listing with limit parameter",
                async run() {
                    // Upload multiple files
                    for (let i = 0; i < 5; i++) {
                        await uploadFile(`file ${i}`, `page-test-${i}.txt`, 'temporary');
                    }

                    // List with limit
                    const limited = await listFiles('temporary', 3);
                    log(`Listed ${limited.length} files with limit=3`);

                    return limited.length <= 3;
                }
            },
            {
                name: "TTL Verification",
                description: "Verify TTL/expiration times for different scopes",
                async run() {
                    const tempFile = await uploadFile('temp', 'ttl-temp.txt', 'temporary');
                    const sessionFile = await uploadFile('session', 'ttl-session.txt', 'session');

                    const tempExpiry = new Date(tempFile.expiresAt);
                    const sessionExpiry = new Date(sessionFile.expiresAt);
                    const now = new Date();

                    // Temporary should expire in ~10 minutes
                    const tempMinutes = (tempExpiry - now) / (1000 * 60);
                    // Session should expire in ~24 hours
                    const sessionHours = (sessionExpiry - now) / (1000 * 60 * 60);

                    log(`Temp expires in: ${tempMinutes.toFixed(1)} minutes`);
                    log(`Session expires in: ${sessionHours.toFixed(1)} hours`);

                    return tempMinutes > 9 && tempMinutes < 11 &&
                           sessionHours > 23 && sessionHours < 25;
                }
            },
            {
                name: "Upload Large File",
                description: "Test uploading a larger file (100KB)",
                async run() {
                    // Create a 100KB string
                    const largeContent = 'x'.repeat(100 * 1024);
                    const file = await uploadFile(largeContent, 'large-file.txt', 'temporary');

                    log(`Uploaded large file: ${file.id}, size: ${file.size} bytes`);

                    return file.size >= 100000;
                }
            },
            {
                name: "Invalid Scope Handling",
                description: "Test error handling for invalid scope",
                async run() {
                    try {
                        await uploadFile('content', 'invalid.txt', 'invalid-scope');
                        return false; // Should have thrown
                    } catch (error) {
                        log(`Expected error for invalid scope: ${error.message}`);
                        return true;
                    }
                }
            }
        ];

        // API Helper functions
        async function apiRequest(endpoint, options = {}) {
            const baseUrl = document.getElementById('apiUrl').value;
            const apiKey = document.getElementById('apiKey').value;

            const response = await fetch(`${baseUrl}${endpoint}`, {
                ...options,
                headers: {
                    'x-api-key': apiKey,
                    ...options.headers
                }
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({ message: 'Unknown error' }));
                throw { status: response.status, ...error };
            }

            return response.json();
        }

        async function uploadFile(content, filename, scope, ownerId = null) {
            const formData = new FormData();
            const blob = new Blob([content], { type: 'text/plain' });
            formData.append('file', blob, filename);
            formData.append('scope', scope);
            if (ownerId) {
                formData.append('ownerId', ownerId);
            }

            return apiRequest('/api/files/upload', {
                method: 'POST',
                body: formData,
                headers: {} // Let browser set content-type for FormData
            });
        }

        async function uploadBase64File(base64Content, filename, mimeType, scope, ownerId = null) {
            const body = {
                file: {
                    content: base64Content,
                    filename,
                    mimeType
                },
                scope,
                ownerId
            };

            return apiRequest('/api/files/upload/base64', {
                method: 'POST',
                body: JSON.stringify(body),
                headers: {
                    'Content-Type': 'application/json'
                }
            });
        }

        async function getFileInfo(fileId) {
            return apiRequest(`/api/files/${fileId}/info`);
        }

        async function downloadFile(downloadUrl) {
            // Direct download without API key
            const response = await fetch(downloadUrl);
            if (!response.ok) {
                throw new Error(`Download failed: ${response.status}`);
            }
            return response.text();
        }

        async function listFiles(scope, limit = 100) {
            const params = new URLSearchParams({
                scope,
                limit
            });

            return apiRequest(`/api/files/list?${params}`);
        }

        async function listAgentFiles(agentId, limit = 100) {
            return apiRequest(`/api/files/agent/${agentId}?limit=${limit}`);
        }

        async function listSessionFiles(sessionId, limit = 100) {
            return apiRequest(`/api/files/session/${sessionId}?limit=${limit}`);
        }

        async function deleteFile(fileId) {
            return apiRequest(`/api/files/${fileId}`, {
                method: 'DELETE'
            });
        }

        // Test runner functions
        let currentTestIndex = 0;
        let testResults = [];

        async function runAllTests() {
            currentTestIndex = 0;
            testResults = [];
            clearConsole();
            log('Starting test suite...');

            for (let i = 0; i < tests.length; i++) {
                await runTest(i);
                // Small delay between tests to avoid rate limiting
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            updateSummary();
            log('Test suite completed!');
        }

        async function runTest(index) {
            const test = tests[index];
            const resultDiv = document.getElementById(`test-${index}`);

            if (!resultDiv) {
                createTestResultDiv(index);
            }

            updateTestStatus(index, 'running');

            try {
                log(`Running: ${test.name}`);
                const result = await test.run();

                if (result) {
                    updateTestStatus(index, 'passed');
                    testResults[index] = 'passed';
                } else {
                    updateTestStatus(index, 'failed');
                    testResults[index] = 'failed';
                }
            } catch (error) {
                log(`Error in ${test.name}: ${error.message || error}`);
                updateTestStatus(index, 'failed', error.message || error.toString());
                testResults[index] = 'failed';
            }

            updateProgress();
        }

        function createTestResultDiv(index) {
            const test = tests[index];
            const container = document.getElementById('testResults');

            const div = document.createElement('div');
            div.id = `test-${index}`;
            div.className = 'bg-gray-50 rounded-lg p-4 border border-gray-200';
            div.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-3">
                            <span class="status-badge px-2 py-1 rounded text-xs font-semibold test-pending">PENDING</span>
                            <h3 class="font-semibold text-gray-900">${test.name}</h3>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">${test.description}</p>
                        <div class="error-message text-red-600 text-sm mt-2 hidden"></div>
                    </div>
                    <button onclick="runTest(${index})" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                        Run Test
                    </button>
                </div>
            `;

            container.appendChild(div);
        }

        function updateTestStatus(index, status, error = null) {
            const resultDiv = document.getElementById(`test-${index}`);
            if (!resultDiv) return;

            const badge = resultDiv.querySelector('.status-badge');
            const errorDiv = resultDiv.querySelector('.error-message');

            // Remove all status classes
            badge.classList.remove('test-pending', 'test-running', 'test-passed', 'test-failed');

            // Add new status class and update text
            switch(status) {
                case 'running':
                    badge.classList.add('test-running');
                    badge.textContent = 'RUNNING';
                    badge.classList.add('text-white');
                    break;
                case 'passed':
                    badge.classList.add('test-passed');
                    badge.textContent = 'PASSED';
                    badge.classList.add('text-white');
                    errorDiv.classList.add('hidden');
                    break;
                case 'failed':
                    badge.classList.add('test-failed');
                    badge.textContent = 'FAILED';
                    badge.classList.add('text-white');
                    if (error) {
                        errorDiv.textContent = `Error: ${error}`;
                        errorDiv.classList.remove('hidden');
                    }
                    break;
                default:
                    badge.classList.add('test-pending');
                    badge.textContent = 'PENDING';
                    badge.classList.add('text-white');
            }
        }

        function updateProgress() {
            const total = tests.length;
            const completed = testResults.filter(r => r !== undefined).length;
            const percentage = (completed / total) * 100;

            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = `${completed} / ${total}`;
        }

        function updateSummary() {
            const total = tests.length;
            const passed = testResults.filter(r => r === 'passed').length;
            const failed = testResults.filter(r => r === 'failed').length;
            const pending = total - passed - failed;

            document.getElementById('totalTests').textContent = total;
            document.getElementById('passedTests').textContent = passed;
            document.getElementById('failedTests').textContent = failed;
            document.getElementById('pendingTests').textContent = pending;
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            testResults = [];
            updateSummary();
            updateProgress();
            clearConsole();

            // Recreate all test divs
            tests.forEach((test, index) => createTestResultDiv(index));
        }

        function log(message) {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.textContent = `[${timestamp}] ${message}`;
            console.appendChild(entry);
            console.scrollTop = console.scrollHeight;
        }

        function clearConsole() {
            document.getElementById('console').innerHTML = '';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Create test result divs
            tests.forEach((test, index) => createTestResultDiv(index));
            updateSummary();

            // Load saved config
            const savedConfig = localStorage.getItem('fileManagerTestConfig');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                document.getElementById('apiKey').value = config.apiKey || '';
                document.getElementById('companyId').value = config.companyId || '';
                document.getElementById('agentId').value = config.agentId || '';
                document.getElementById('sessionId').value = config.sessionId || '';
            }

            // Save config on change
            ['apiKey', 'companyId', 'agentId', 'sessionId'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    const config = {
                        apiKey: document.getElementById('apiKey').value,
                        companyId: document.getElementById('companyId').value,
                        agentId: document.getElementById('agentId').value,
                        sessionId: document.getElementById('sessionId').value
                    };
                    localStorage.setItem('fileManagerTestConfig', JSON.stringify(config));
                });
            });
        });
    </script>
</body>
</html>