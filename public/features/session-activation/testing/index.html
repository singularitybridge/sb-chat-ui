<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Activation Testing Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .test-passed { background-color: #10b981; }
        .test-failed { background-color: #ef4444; }
        .test-running { background-color: #3b82f6; }
        .test-pending { background-color: #6b7280; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Session Activation Testing Suite</h1>
            <p class="text-gray-600">Test the new session activation and management features</p>

            <div class="mt-4 flex flex-wrap gap-2">
                <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">Session Management</span>
                <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">Active Session Control</span>
                <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-medium">Multi-Session Handling</span>
            </div>
        </div>

        <!-- Configuration -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Configuration</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">API Base URL</label>
                    <input type="text" id="apiUrl" value="http://localhost:4103"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                    <input type="password" id="apiKey" placeholder="Enter your API key"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Company ID</label>
                    <input type="text" id="companyId" placeholder="Your company ID"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">User ID</label>
                    <input type="text" id="userId" placeholder="Your user ID"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
        </div>

        <!-- Test Controls -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-900">Test Suite</h2>
                <div class="flex gap-2">
                    <button onclick="runAllTests()"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        Run All Tests
                    </button>
                    <button onclick="clearResults()"
                            class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium">
                        Clear Results
                    </button>
                </div>
            </div>

            <!-- Test Progress -->
            <div class="mb-4">
                <div class="flex justify-between text-sm text-gray-600 mb-1">
                    <span>Progress</span>
                    <span id="progressText">0 / 0</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <!-- Test Results Summary -->
            <div class="grid grid-cols-4 gap-2 mb-4">
                <div class="bg-gray-50 p-3 rounded-lg text-center">
                    <div class="text-2xl font-bold text-gray-700" id="totalTests">0</div>
                    <div class="text-xs text-gray-500">Total</div>
                </div>
                <div class="bg-green-50 p-3 rounded-lg text-center">
                    <div class="text-2xl font-bold text-green-600" id="passedTests">0</div>
                    <div class="text-xs text-gray-500">Passed</div>
                </div>
                <div class="bg-red-50 p-3 rounded-lg text-center">
                    <div class="text-2xl font-bold text-red-600" id="failedTests">0</div>
                    <div class="text-xs text-gray-500">Failed</div>
                </div>
                <div class="bg-blue-50 p-3 rounded-lg text-center">
                    <div class="text-2xl font-bold text-blue-600" id="pendingTests">0</div>
                    <div class="text-xs text-gray-500">Pending</div>
                </div>
            </div>
        </div>

        <!-- Individual Tests -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Test Cases</h2>
            <div id="testResults" class="space-y-3"></div>
        </div>

        <!-- Debug Console -->
        <div class="bg-gray-900 rounded-lg shadow-sm p-6 mt-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-white">Debug Console</h2>
                <button onclick="clearConsole()" class="text-gray-400 hover:text-white text-sm">Clear</button>
            </div>
            <div id="console" class="bg-black rounded p-4 h-64 overflow-y-auto font-mono text-sm text-green-400"></div>
        </div>
    </div>

    <script>
        // Test configuration
        const tests = [
            {
                name: "Create Multiple Sessions",
                description: "Create 3 sessions for testing activation",
                async run() {
                    const sessions = [];
                    for (let i = 1; i <= 3; i++) {
                        const session = await createSession(`Test Session ${i}`);
                        sessions.push(session);
                        log(`Created session ${i}: ${session.id}`);
                    }
                    window.testSessions = sessions;
                    return sessions.length === 3;
                }
            },
            {
                name: "Check Initial Active Session",
                description: "Verify only the last created session is active",
                async run() {
                    const sessions = await getRecentSessions();
                    const activeSessions = sessions.filter(s => s.active);
                    log(`Found ${activeSessions.length} active session(s)`);
                    return activeSessions.length === 1;
                }
            },
            {
                name: "Activate Different Session",
                description: "Activate the first session and verify it becomes active",
                async run() {
                    if (!window.testSessions || window.testSessions.length < 2) {
                        throw new Error("Test sessions not found");
                    }
                    const firstSession = window.testSessions[0];
                    const result = await activateSession(firstSession.id);
                    log(`Activated session: ${firstSession.id}`);

                    const sessions = await getRecentSessions();
                    const activeSession = sessions.find(s => s.active);
                    return activeSession && activeSession._id === firstSession.id;
                }
            },
            {
                name: "Verify Previous Session Deactivated",
                description: "Check that previously active session is now inactive",
                async run() {
                    const sessions = await getRecentSessions();
                    const activeSessions = sessions.filter(s => s.active);
                    log(`Active sessions count: ${activeSessions.length}`);

                    // Should have exactly one active session
                    if (activeSessions.length !== 1) return false;

                    // The active session should be the one we just activated
                    return activeSessions[0]._id === window.testSessions[0].id;
                }
            },
            {
                name: "Activate Already Active Session",
                description: "Activating an already active session should be idempotent",
                async run() {
                    const activeSession = window.testSessions[0];
                    const result = await activateSession(activeSession.id);

                    const sessions = await getRecentSessions();
                    const activeSessions = sessions.filter(s => s.active);
                    return activeSessions.length === 1 && activeSessions[0]._id === activeSession.id;
                }
            },
            {
                name: "Get Recent Sessions with Limit",
                description: "Test pagination with limit parameter",
                async run() {
                    const sessions2 = await getRecentSessions(2);
                    const sessions5 = await getRecentSessions(5);

                    log(`Got ${sessions2.length} sessions with limit=2`);
                    log(`Got ${sessions5.length} sessions with limit=5`);

                    return sessions2.length <= 2 && sessions5.length <= 5;
                }
            },
            {
                name: "Activate Non-Existent Session",
                description: "Should fail gracefully when activating invalid session",
                async run() {
                    try {
                        await activateSession("invalid-session-id");
                        return false; // Should have thrown
                    } catch (error) {
                        log(`Expected error: ${error.message}`);
                        return true;
                    }
                }
            },
            {
                name: "Session Ownership Validation",
                description: "Cannot activate another user's session",
                async run() {
                    // This test would require a different user's session ID
                    // For now, we'll test with an invalid ObjectId format
                    try {
                        await activateSession("507f1f77bcf86cd799439011");
                        return false; // Should have thrown
                    } catch (error) {
                        log(`Expected error for wrong ownership: ${error.message}`);
                        return error.status === 404 || error.status === 400;
                    }
                }
            },
            {
                name: "Multiple Rapid Activations",
                description: "Test race conditions with rapid session switches",
                async run() {
                    if (!window.testSessions || window.testSessions.length < 3) {
                        throw new Error("Need at least 3 sessions for this test");
                    }

                    // Rapidly switch between sessions
                    const promises = window.testSessions.map(session =>
                        activateSession(session.id).catch(e => e)
                    );

                    await Promise.all(promises);

                    // Check that we still have exactly one active session
                    const sessions = await getRecentSessions();
                    const activeSessions = sessions.filter(s => s.active);

                    log(`After rapid switches: ${activeSessions.length} active session(s)`);
                    return activeSessions.length === 1;
                }
            },
            {
                name: "Session Activation with Metadata",
                description: "Verify session metadata is preserved after activation",
                async run() {
                    const targetSession = window.testSessions[1];
                    await activateSession(targetSession.id);

                    const sessions = await getRecentSessions();
                    const activated = sessions.find(s => s._id === targetSession.id);

                    return activated &&
                           activated.active === true &&
                           activated.userId === targetSession.userId &&
                           activated.companyId === targetSession.companyId;
                }
            }
        ];

        // API Helper functions
        async function apiRequest(endpoint, options = {}) {
            const baseUrl = document.getElementById('apiUrl').value;
            const apiKey = document.getElementById('apiKey').value;

            const response = await fetch(`${baseUrl}${endpoint}`, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    ...options.headers
                }
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({ message: 'Unknown error' }));
                throw { status: response.status, ...error };
            }

            return response.json();
        }

        async function createSession(name = "Test Session") {
            const userId = document.getElementById('userId').value;
            const companyId = document.getElementById('companyId').value;

            return apiRequest('/api/sessions', {
                method: 'POST',
                body: JSON.stringify({
                    userId,
                    companyId,
                    assistantId: '674e3b6e95c5c9a37af4a916', // Default assistant
                    language: 'en'
                })
            });
        }

        async function activateSession(sessionId) {
            return apiRequest(`/api/sessions/${sessionId}/activate`, {
                method: 'POST'
            });
        }

        async function getRecentSessions(limit = 10) {
            return apiRequest(`/api/sessions?limit=${limit}`);
        }

        // Test runner functions
        let currentTestIndex = 0;
        let testResults = [];

        async function runAllTests() {
            currentTestIndex = 0;
            testResults = [];
            clearConsole();
            log('Starting test suite...');

            for (let i = 0; i < tests.length; i++) {
                await runTest(i);
            }

            updateSummary();
            log('Test suite completed!');
        }

        async function runTest(index) {
            const test = tests[index];
            const resultDiv = document.getElementById(`test-${index}`);

            if (!resultDiv) {
                createTestResultDiv(index);
            }

            updateTestStatus(index, 'running');

            try {
                log(`Running: ${test.name}`);
                const result = await test.run();

                if (result) {
                    updateTestStatus(index, 'passed');
                    testResults[index] = 'passed';
                } else {
                    updateTestStatus(index, 'failed');
                    testResults[index] = 'failed';
                }
            } catch (error) {
                log(`Error in ${test.name}: ${error.message || error}`);
                updateTestStatus(index, 'failed', error.message || error.toString());
                testResults[index] = 'failed';
            }

            updateProgress();
        }

        function createTestResultDiv(index) {
            const test = tests[index];
            const container = document.getElementById('testResults');

            const div = document.createElement('div');
            div.id = `test-${index}`;
            div.className = 'bg-gray-50 rounded-lg p-4 border border-gray-200';
            div.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-3">
                            <span class="status-badge px-2 py-1 rounded text-xs font-semibold test-pending">PENDING</span>
                            <h3 class="font-semibold text-gray-900">${test.name}</h3>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">${test.description}</p>
                        <div class="error-message text-red-600 text-sm mt-2 hidden"></div>
                    </div>
                    <button onclick="runTest(${index})" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                        Run Test
                    </button>
                </div>
            `;

            container.appendChild(div);
        }

        function updateTestStatus(index, status, error = null) {
            const resultDiv = document.getElementById(`test-${index}`);
            if (!resultDiv) return;

            const badge = resultDiv.querySelector('.status-badge');
            const errorDiv = resultDiv.querySelector('.error-message');

            // Remove all status classes
            badge.classList.remove('test-pending', 'test-running', 'test-passed', 'test-failed');

            // Add new status class and update text
            switch(status) {
                case 'running':
                    badge.classList.add('test-running');
                    badge.textContent = 'RUNNING';
                    badge.classList.add('text-white');
                    break;
                case 'passed':
                    badge.classList.add('test-passed');
                    badge.textContent = 'PASSED';
                    badge.classList.add('text-white');
                    errorDiv.classList.add('hidden');
                    break;
                case 'failed':
                    badge.classList.add('test-failed');
                    badge.textContent = 'FAILED';
                    badge.classList.add('text-white');
                    if (error) {
                        errorDiv.textContent = `Error: ${error}`;
                        errorDiv.classList.remove('hidden');
                    }
                    break;
                default:
                    badge.classList.add('test-pending');
                    badge.textContent = 'PENDING';
                    badge.classList.add('text-white');
            }
        }

        function updateProgress() {
            const total = tests.length;
            const completed = testResults.filter(r => r !== undefined).length;
            const percentage = (completed / total) * 100;

            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = `${completed} / ${total}`;
        }

        function updateSummary() {
            const total = tests.length;
            const passed = testResults.filter(r => r === 'passed').length;
            const failed = testResults.filter(r => r === 'failed').length;
            const pending = total - passed - failed;

            document.getElementById('totalTests').textContent = total;
            document.getElementById('passedTests').textContent = passed;
            document.getElementById('failedTests').textContent = failed;
            document.getElementById('pendingTests').textContent = pending;
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            testResults = [];
            updateSummary();
            updateProgress();
            clearConsole();

            // Recreate all test divs
            tests.forEach((test, index) => createTestResultDiv(index));
        }

        function log(message) {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.textContent = `[${timestamp}] ${message}`;
            console.appendChild(entry);
            console.scrollTop = console.scrollHeight;
        }

        function clearConsole() {
            document.getElementById('console').innerHTML = '';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Create test result divs
            tests.forEach((test, index) => createTestResultDiv(index));
            updateSummary();

            // Load saved config
            const savedConfig = localStorage.getItem('sessionTestConfig');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                document.getElementById('apiKey').value = config.apiKey || '';
                document.getElementById('companyId').value = config.companyId || '';
                document.getElementById('userId').value = config.userId || '';
            }

            // Save config on change
            ['apiKey', 'companyId', 'userId'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    const config = {
                        apiKey: document.getElementById('apiKey').value,
                        companyId: document.getElementById('companyId').value,
                        userId: document.getElementById('userId').value
                    };
                    localStorage.setItem('sessionTestConfig', JSON.stringify(config));
                });
            });
        });
    </script>
</body>
</html>